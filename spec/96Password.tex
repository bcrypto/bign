\begin{appendix}{Е}{справочное}
{Парольная защита личного ключа}
\label{PASSWORD}

\hiddensection{Назначение}\label{PASSWORD.Common}

Конфиденциальность и контроль целостности личного ключа при его
хранении могут обеспечиваться разными способами. 
Одним из таких способов является защита ключа на пароле владельца.
%
В настоящем приложении определяются алгоритмы парольной защиты, 
идентификаторы алгоритмов,
структуры данных для хранения параметров алгоритмов.
Определения соответствуют стандарту~\cite{PKCS5}. 

Паролем является двоичное слово, 
длина которого кратна~$8$. Это слово может являться
кодированным представлением обычной текстовой строки. 
Кодировать рекомендуется по правилам UTF-8, 
заданным в~\cite{UTF8}.

Парольная защита выполняется в два этапа. 
Сначала с помощью алгоритма~\ref{PASSWORD.PBKDF.Alg}
по паролю и дополнительным служебным данным 
строится секретный ключ защиты~$\theta$. 
Затем на этом ключе с помощью алгоритмов, 
описанных в~\ref{PASSWORD.Protect}, 
устанавливается или снимается защита личного ключа.

Алгоритм~\ref{PASSWORD.PBKDF.Alg} имеет самостоятельное значение.
Вырабатываемый с его помощью ключ~$\theta$ может использоваться
для защиты произвольных личных и секретных ключей,
а также сопровождающих их служебных данных.
Защита может выполняться с помощью алгоритмов, не обязательно совпадающих 
с алгоритмами~\ref{PASSWORD.Protect}. 

Владелец личного ключа должен оградить доступ других лиц
даже к защищенному ключу.
%
Тем не менее, угроза такого доступа существует, и парольная 
защита организуется так, чтобы максимально затруднить 
определение ключа без знания пароля.

Для этого, во-первых, владелец должен использовать высокоэнтропийные 
пароли (большой длины, с цифрами и буквами, 
без многократных повторов символов и т.д.).
%
Во-вторых, при построении~$\theta$ 
выполняется несколько итераций, на которых
последовательно вычисляются значения сложной необратимой функции.
%
Регулируя число итераций~$c$, можно сделать неприемлемо большим время, 
которое требуется злоумышленнику для перебора паролей,
оставляя допустимым время, затрачиваемое владельцем 
на выработку ключа защиты.
%
В-третьих, при построении~$\theta$, кроме пароля,
используется синхропосылка~$S$ (salt, <<соль>> в~\cite{PKCS5}). 
Вырабатываемый ключ защиты зависит от выбранной синхропосылки, 
и злоумышленник лишается возможности предварительно 
рассчитывать ключи для определенных классов паролей,
т.~е. проводить так называемые словарные атаки.

Число итераций~$c$ и синхропосылка~$S$ являются несекретными элементами
и могут сохраняться вместе с защищенным личным ключом.
%
Рекомендуется выбирать~$c\geq 10000$ и
использовать синхропосылки (двоичные слова), 
длина которых не меньше~$64$. 
%
Рекомендуется вырабатывать синхропосылки случайным 
или псевдослучайным методом.

%\doubt{перечитать, сказать о том что парольную зашиту 
%можно использовать для любых ключей, не только для личных}

\hiddensection{Построение ключа защиты по паролю}
\label{PASSWORD.PBKDF}

\subsection{Входные и выходные данные}
\label{PASSWORD.PBKDF.IO}

Входными данными алгоритма построения ключа защиты являются
пароль~$P\in\{0,1\}^{8*}$, 
число итераций~$c\in\{1,2,\ldots\}$
и синхропосылка~$S\in\{0,1\}^{8*}$.

Выходными данными алгоритма является ключ 
защиты~$\theta\in\{0,1\}^{256}$.
  
\subsection{Вспомогательные алгоритмы и преобразования}
\label{PASSWORD.PBKDF.Aux}
 
Используется алгоритм HMAC,
определенный в СТБ~34.101.47 (пункт 6.1),
с базовым алгоритмом хэширования~\algname{belt-hash}.
Входными данными алгоритма~$\HMAC_{\algname{belt-hash}}$ являются 
ключ~$K\in\{0,1\}^*$ и сообщение~$X\in\{0,1\}^*$,
выходными~--- имитовставка~$Y\in\{0,1\}^{256}$.

Используется переменная~$t\in\{0,1\}^{256}$.
Значение~$t$ должно быть уничтожено после использования.

\subsection{Алгоритм построения ключа защиты по паролю}
\label{PASSWORD.PBKDF.Alg}

Построение ключа защиты состоит в выполнении следующих шагов:
\begin{enumerate}
\item
Установить
$\theta\leftarrow\HMAC_{\algname{belt-hash}}
(P,S\parallel \hex{00000001})$.
\item
Установить~$t\leftarrow \theta$.
\item
Для $i=2,3,\ldots,c$ выполнить:
\begin{enumerate}
\item
$t\leftarrow\HMAC_{\algname{belt-hash}}(P,t)$;
\item
$\theta\leftarrow\theta\oplus t$.
\end{enumerate}
\item
Возвратить~$\theta$.
\end{enumerate}

\hiddensection{Алгоритмы защиты личного ключа}\label{PASSWORD.Protect}

Защита личного ключа состоит в применении алгоритмов~\algname{belt-keywrap} 
и~\algname{belt-keyunwrap}, описанных в~\ref{TRANSPORT.Aux}
настоящего стандарта.

В этих алгоритмах должен использоваться заголовок~$I=0^{128}$
и ключ~$\theta\in\{0,1\}^{256}$, построенный по паролю.
На уровне стойкости~$l$ личный ключ~$d$ должен представляться 
двоичным словом~$\langle d\rangle_{2l}$.

Возврат алгоритмом~\algname{belt-keyunwrap} признака~\algname{ОШИБКА}  
означает, что ключ~$\theta$ некорректен
или что нарушена целостность личного ключа.

\hiddensection{Идентификаторы и параметры алгоритмов}\label{PASSWORD.Ids}

Алгоритмам парольной защиты присваиваются следующие идентификаторы:
\begin{center}
\begin{tabular}{p{4cm}p{12cm}}
\algname{id-PBKDF2} &
алгоритм построения ключа защиты по паролю (\ref{PASSWORD.PBKDF.Alg});\\
%
\algname{id-PBES2} &
алгоритмы защиты личного ключа (\ref{PASSWORD.Protect}).\\
\end{tabular}
\end{center}

Данные идентификаторы определены в~\cite{PKCS5}
следующим образом:
\begin{verbatim}
pkcs OBJECT IDENTIFIER ::= {iso(1) member-body(2) us(840) rsadsi(113549) 1}
pkcs-5 OBJECT IDENTIFIER ::= {pkcs 5}
id-PBKDF2 OBJECT IDENTIFIER ::= {pkcs-5 12}
id-PBES2 OBJECT IDENTIFIER ::= {pkcs-5 13}
\end{verbatim}

Если идентификатор~\algname{id-PBKDF2} используется в
компоненте~\algname{algorithm} типа \algname{AlgorithmIdentifier}
(см.~\ref{ASN.Params}),
то соответствующий компонент~\algname{parameters} должен иметь тип
\begin{verbatim}
PBKDF2-params ::= SEQUENCE {
  salt CHOICE {
    specified OCTET STRING,
    otherSource AlgorithmIdentifier
  },
  iterationCount INTEGER (1..MAX),
  keyLength INTEGER (32) OPTIONAL,
  prf AlgorithmIdentifier
}
\end{verbatim}

Компонент \algname{salt} этого типа определяет синхропосылку~$S$.
Синхропосылка может быть задана явно строкой \algname{specified}
либо алгоритмически через компонент~\algname{otherSource}.
%
Компонент \algname{iterationCount} описывает число итераций~$c$.
%
Необязательный компонент~\algname{keyLenght} 
описывает длину ключа защиты~$\theta$ в октетах.
%
Компонент~\algname{prf} описывает алгоритм~$\HMAC_{\algname{belt-hash}}$.

Вложенный в~\algname{prf} компонент~\algname{algorithm}
должен принимать значение~\algname{hmac-hbelt},
а компонент~\algname{parameters}~--- значение~\algname{NULL}.
%
Идентификатор~\algname{hmac-hbelt} 
определен в СТБ~34.101.47 (приложение~A).

Если идентификатор~\algname{id-PBES2} используется в
компоненте~\algname{algorithm} типа~\algname{AlgorithmIdentifier},
то соответствующий компонент~\algname{parameters} должен иметь тип
\begin{verbatim}
PBES2-params ::= SEQUENCE {
  keyDerivationFunc AlgorithmIdentifier,
  encryptionScheme AlgorithmIdentifier
}
\end{verbatim}

Вложенный в~\algname{keyDerivationFunc} компонент~\algname{algorithm}
должен принимать значение \algname{id-PBKDF2},
а компонент~\algname{parameters}~--- значение типа~\algname{PBKDF2-params}.

Вложенный в~\algname{encryptionScheme} компонент~\algname{algorithm}
должен принимать значение \algname{belt-keywrap256},
а компонент~\algname{parameters}~--- значение~\algname{NULL}.
%
Идентификатор~\algname{belt-keywrap256} 
определен в СТБ~34.101.31 (приложение~Б).

\hiddensection{Проверочный пример}
\label{PASSWORD.Test}

В таблице~\ref{Table.PASSWORD.TestPBKDF} представлен пример 
построения ключа защиты~$\theta$ по паролю,
дополнительно указывается 
результат~$Y$ защиты личного ключа~$d$ из таблицы~\ref{Table.TEST.GenKeyPair}
на ключе~$\theta$.

\begin{table}[H]
\caption{Построение ключа защиты по паролю}\label{Table.PASSWORD.TestPBKDF}
{\small
\begin{tabular}{|l|l|}
\hline
$\phantom{\langle}P$ & 
$\hex{42313934~42414338~30413038~46353342}$\\
% 
% "B194BAC80A08F53B"
%
\hline
$\phantom{\langle}c$ & 
10000\\
%
\hline
$\phantom{\langle}S$ & 
$\hex{BE329713~43FC9A48}$\\
%
\hline
\hline
$\phantom{\langle}\theta$ & 
$\hex{3D331BBB~B1FBBB40~E4BF22F6~CB9A689E~F13A77DC~09ECF932~91BFE424~39A72E7D}$\\
\hline
\hline
$\phantom{\langle}Y$ &
$\hexz{4EA289D5~F718087D~D8EDB305~BA1CE898~0E5EC3E0~B56C8BF9~D5C3E909~CF4C14F0}$\\
&
$\hex{7B8204E6~7841A165~E924945C~D07F37E7}$\\
\hline
\end{tabular}
}
\end{table}

\end{appendix}

